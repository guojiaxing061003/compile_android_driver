name: Android Kernel Module Only Builder (Fast)

# 专为 GitHub 免费用户优化 - 仅编译 .ko 模块，不编译内核镜像
# 预计编译时间: 30-60分钟（远低于6小时限制）

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version'
        required: true
        default: '14'
        type: choice
        options:
          - '13'
          - '14'
          - '15'
      kernel_version:
        description: 'Kernel Version'
        required: true
        default: '6.1'
        type: choice
        options:
          - '5.15'
          - '6.1'
          - '6.6'
      driver_name:
        description: 'Driver Module Name (without .ko)'
        required: true
        default: 'kernel_hack'
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'aarch64'
        type: choice
        options:
          - 'aarch64'
          - 'x86_64'

jobs:
  build-module:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2小时足够，留大量余量
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: Install minimal dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential bc flex bison libssl-dev libelf-dev \
            python3 python-is-python3 git curl wget cpio kmod

      - name: Setup repo tool
        run: |
          sudo curl -sL https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo
          git config --global user.email "builder@github.com"
          git config --global user.name "Builder"
          git config --global color.ui false

      - name: Prepare driver source
        run: |
          mkdir -p kerneldriver
          if [ -d "./code" ]; then
            cp ./code/*.h ./code/*.c ./code/Makefile kerneldriver/ 2>/dev/null || true
          fi
          echo "=== Driver files ==="
          ls -la kerneldriver/

      # 关键优化：使用预编译的内核头文件而不是完整源码
      - name: Download prebuilt kernel headers (Fast Method)
        id: prebuilt
        run: |
          ANDROID_VER="${{ github.event.inputs.android_version }}"
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
          ARCH="${{ github.event.inputs.target_arch }}"
          
          echo "Attempting to download prebuilt kernel headers..."
          
          # 尝试从 Google 的 CI 获取预编译头文件
          BRANCH="android$ANDROID_VER-$KERNEL_VER"
          
          # 创建目录
          mkdir -p kernel-headers
          
          # 方法1: 尝试下载预编译的 kernel-headers
          PREBUILT_URL="https://android.googlesource.com/kernel/prebuilts/build-tools/+archive/refs/heads/main.tar.gz"
          
          # 如果预编译不可用，标记需要最小化源码同步
          echo "prebuilt_available=false" >> $GITHUB_OUTPUT
        continue-on-error: true

      # 最小化内核源码同步 - 只获取编译模块所需的文件
      - name: Minimal kernel source sync
        if: steps.prebuilt.outputs.prebuilt_available != 'true'
        run: |
          ANDROID_VER="${{ github.event.inputs.android_version }}"
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
          ARCH="${{ github.event.inputs.target_arch }}"
          BRANCH="common-android$ANDROID_VER-$KERNEL_VER"
          
          mkdir -p android-kernel && cd android-kernel
          
          echo "=== Minimal sync for branch: $BRANCH ==="
          
          # 超浅克隆 - 只获取最新提交
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b $BRANCH \
            --depth=1 \
            --partial-clone \
            --clone-filter=blob:limit=1M
          
          # 只同步必要的项目
          repo sync -c -j$(nproc) --no-tags --optimized-fetch \
            --force-sync --current-branch --no-clone-bundle \
            common build prebuilts/clang/host/linux-x86 prebuilts-master/clang/host/linux-x86 2>/dev/null || \
          repo sync -c -j$(nproc) --no-tags --optimized-fetch --force-sync
          
          echo "=== Sync completed ==="
          df -h

      - name: Setup driver in kernel tree
        run: |
          cd android-kernel
          mkdir -p common/drivers/kerneldriver
          cp -r ../kerneldriver/* common/drivers/kerneldriver/
          
          # 确保有 Makefile
          if [ ! -f "common/drivers/kerneldriver/Makefile" ]; then
            cat > common/drivers/kerneldriver/Makefile << 'EOF'
          obj-m += ${{ github.event.inputs.driver_name }}.o
          EOF
          fi
          
          # 添加到 drivers Makefile
          grep -q "kerneldriver" common/drivers/Makefile || \
            echo "obj-m += kerneldriver/" >> common/drivers/Makefile

      - name: Generate minimal kernel config
        run: |
          cd android-kernel/common
          ARCH="${{ github.event.inputs.target_arch }}"
          
          # 使用 GKI defconfig 作为基础
          if [ "$ARCH" = "aarch64" ]; then
            DEFCONFIG="gki_defconfig"
            MAKE_ARCH="arm64"
          else
            DEFCONFIG="gki_defconfig"
            MAKE_ARCH="x86_64"
          fi
          
          # 查找交叉编译器
          if [ -d "../prebuilts-master/clang/host/linux-x86/clang-r487747c" ]; then
            CLANG_PATH="../prebuilts-master/clang/host/linux-x86/clang-r487747c/bin"
          elif [ -d "../prebuilts/clang/host/linux-x86/clang-r487747c" ]; then
            CLANG_PATH="../prebuilts/clang/host/linux-x86/clang-r487747c/bin"
          else
            CLANG_PATH=$(find ../prebuilts* -type d -name "clang-r*" 2>/dev/null | head -1)/bin
          fi
          
          echo "CLANG_PATH=$CLANG_PATH" >> $GITHUB_ENV
          echo "MAKE_ARCH=$MAKE_ARCH" >> $GITHUB_ENV
          
          # 生成配置
          if [ "$MAKE_ARCH" = "arm64" ]; then
            make ARCH=$MAKE_ARCH LLVM=1 LLVM_IAS=1 \
              CC="$CLANG_PATH/clang" \
              CROSS_COMPILE="$CLANG_PATH/aarch64-linux-gnu-" \
              $DEFCONFIG 2>/dev/null || make ARCH=$MAKE_ARCH defconfig
          else
            make ARCH=$MAKE_ARCH LLVM=1 CC="$CLANG_PATH/clang" $DEFCONFIG 2>/dev/null || make ARCH=$MAKE_ARCH defconfig
          fi
          
          # 启用模块支持
          scripts/config --enable CONFIG_MODULES
          scripts/config --enable CONFIG_MODULE_UNLOAD
          scripts/config --disable CONFIG_MODULE_SIG_FORCE
          scripts/config --disable CONFIG_MODVERSIONS 2>/dev/null || true

      # 核心优化：只编译模块，不编译内核
      - name: Build kernel module ONLY (Fast)
        run: |
          cd android-kernel/common
          ARCH="${{ github.event.inputs.target_arch }}"
          DRIVER="${{ github.event.inputs.driver_name }}"
          
          if [ "$ARCH" = "aarch64" ]; then
            MAKE_ARCH="arm64"
            CROSS="CROSS_COMPILE=$CLANG_PATH/aarch64-linux-gnu-"
          else
            MAKE_ARCH="x86_64"
            CROSS=""
          fi
          
          echo "=== Building module only (not full kernel) ==="
          
          # 方法1: 直接编译单个模块目录
          make ARCH=$MAKE_ARCH LLVM=1 LLVM_IAS=1 \
            CC="$CLANG_PATH/clang" $CROSS \
            -j$(nproc) \
            M=drivers/kerneldriver modules 2>&1 || {
            
            echo "=== Method 1 failed, trying prepare + modules ==="
            
            # 方法2: 先准备内核头文件，再编译模块
            make ARCH=$MAKE_ARCH LLVM=1 LLVM_IAS=1 \
              CC="$CLANG_PATH/clang" $CROSS \
              -j$(nproc) prepare modules_prepare 2>&1
            
            make ARCH=$MAKE_ARCH LLVM=1 LLVM_IAS=1 \
              CC="$CLANG_PATH/clang" $CROSS \
              -j$(nproc) \
              M=drivers/kerneldriver modules 2>&1
          }
          
          echo "=== Module build completed ==="

      - name: Collect built modules
        run: |
          mkdir -p output
          
          # 搜索编译产物
          find android-kernel -name "*.ko" -type f 2>/dev/null | while read ko; do
            echo "Found: $ko"
            cp "$ko" output/
          done
          
          echo "=== Built modules ==="
          ls -la output/
          
          # 显示模块信息
          for ko in output/*.ko; do
            if [ -f "$ko" ]; then
              echo "=== Module info: $ko ==="
              file "$ko"
              modinfo "$ko" 2>/dev/null || true
            fi
          done

      - name: Upload kernel module
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.driver_name }}-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}-${{ github.event.inputs.target_arch }}
          path: output/*.ko
          retention-days: 30
          if-no-files-found: warn

      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Android Version: ${{ github.event.inputs.android_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Kernel Version: ${{ github.event.inputs.kernel_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Architecture: ${{ github.event.inputs.target_arch }}" >> $GITHUB_STEP_SUMMARY
          echo "- Driver: ${{ github.event.inputs.driver_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "output/${{ github.event.inputs.driver_name }}.ko" ]; then
            echo "✅ Module built successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Module may not have been built. Check logs." >> $GITHUB_STEP_SUMMARY
          fi
